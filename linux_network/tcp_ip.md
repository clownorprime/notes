## ISO/OSI

每一个对等层传输单位统称为PDU(protocal data unit)协议数据单元
物理层：传输单位为byte; 功能比特流传输,定义了物理设备的规范， 为上层的数据链路层提供了一个物理介质；本层定义的规范有EIA/TIA RS-232, RJ-45等
网卡属于本层，为上层的数据链路层提供了一个物理介质

数据链路层：传输单位为frame; 介质访问和链路管理
对物理层收到的比特流进行数据成帧，提供可靠的数据传输服务，实现无差错的数据传输；本层的协议有SDLC, HDLC, STP, PPP, 帧中继等; switch交换机属于本层。
网络层:单位为packet;   功能寻址和路由选择，负责将各个子网之间的数据进行路由选择，分组和重组。本层定义的协议有IP,IPX, ICMP, IGMP等，路由器属于本层。
传输层：单位为segment; 功能建立端对端连接。
本层定义的协议有TCP, UDP.
会话层: 单位为SPDU;  功能建立维护和管理会话
表示层：单位为PPDU;  功能处理数据格式，进行数据加密等
应用层: 单位为APDU； 功能提供应用程序间通信. 定义的协议有HTTP, FTP, TELNET, SSH, SMTP，POP3等.
## TCP/IP四层模型
链路层
ARP与RARP协议属于该层，ARP是将IP地址转换为MAC地址，RAPR正相反。
网络层
传输层
应用层

每一层之间可以采用一致协议进行通信，不同层之间由于具有不同的协议因而无法通信。
TCP/IP协议栈就是一个push, pop的过程，将原始的比特流加上应用头部、TCP头部、IP头部、以太网头部之后封装完成通过网卡、switch交换机、路由器等传递给另外一台主机，然后由主机解封完成，整个过程就是一个先进后出，push pop的过程，因此成为TCP/IP协议栈。

分用也就是解封的过程，是网络层即IP通过IP地址决定传输给哪一台主机。端口是主机在传输层上用来确定传递给哪一个应用程序。

## 链路层
### MTU(Maximum Transmisson unit)
以太网能够传输的数据帧的最大长度称为MTU，如果IP层有一个数据报的长度大于MTU，那么这时IP层就需要对数据包进行切片，每个切片大小均小于MTU。
### 路径MTU
当网路上的两台主机进行通信时，通信所经历的各个网络中链路层即以太网能够传输的MTU大小可能不同，我们称这条路径上最小的MTU为路径MTU。
我们可以自己选择数据包的大小，应选择的数据包大小应该尽量避免切片，以保证传输效率。

### 以太网帧协议
考虑一下以太网帧，从网络层传输给链路层的数据包可能有很多类型，比如ARP请求，IP数据包的传送，因此，以太网头部需要添加一个类型已标记以太网帧的类型，从而方便目的主机解封时针对不同的以太网帧进行不同的处理。  
这个类型占据两个字节，0x0800代表IP数据报，而0x0806代表ARP请求，0x8035代表RARP请求。

### ICMP协议
ICMP协议位于网络层，用于传递差错信息，时间，回显，网络信息等控制数据。
比如, 我们在主机A上请求一个IP地址的MAC地址，如果经历ARP之后，由于IP地址不存在等原因，无法得到MAC地址，那么这个时候就需要把错误信息返回给源端，错误信息采用ICMP协议进行封装后返回给源端主机B.一般是由包传递到的TTL值为0的那个路由器发送.
另外，如果我们设置IP层不可分片，这个时候如果IP数据报的长度大于MTU,那么这个时候需要返回错误信息给源端，这时错误信息也是采用ICMP协议的格式返回给源端。

### ARP协议(Adress resolution protocol)
ARP协议工作在链路层，以太网帧需要包含目的端的MAC地址，然而在应用层我们通常只给出了目的端的IP地址，这时我们可以通过ARP协议来获取目的端的MAC地址。

其过程如下：
1. 根据目的端的IP地址查询本机的ARP缓存，如果ARP缓存中有目的端的IP地址，那么就可以获取目的端的IP地址。
2. ARP缓存中没有目的端的记录，这时候发送广播ARP请求包，网络上的每台机器都收到并打开上传到网络层，对比本机的IP地址与ARP请求包的IP地址，如果不同，那么就舍弃，如果相同，那么就回复ARP请求，在回复中告知自己的MAC地址，同时将源端的IP地址和MAC地址保存在本机的ARP缓存中。源端接收到ARP回复后，在ARP缓冲中添加进该条记录。并将目的端的MAC地址填写到数据帧中。

### 例子(Ping): 数据在网络中的传输过程
1. 应用程序ping会判断发送的是IP地址还是主机名，如果发送的是主机名，通过gethostbyname将主机名转化为IP地址，这个过程称为DNS地址解析。
2. ping程序向目的主机发送一个ICMP的ECHO包
3. 通过ARP协议获得目的主机的MAC地址
4. 发送ICMP数据包到主机B
5. 目的主机接收到源端的ICMP包，发送响应包
6. 源端接收到目的主机传回的响应包，在屏幕上打印相关信息。
### RARP协议（反地址解析协议）
通常用于无硬盘的工作站，IP地址一般保存在配置文件中，无硬盘意味着无法获得IP地址，这时需要通过本机的MAC地址发送RARP数据包到RARP服务器从而获取本机的IP地址，这一过程称为反地址解析协议。

## 网络层 
### IP数据包格式 
1. 版本
占据4位，IPv4此字段为4， IPv6该字段为6
2. 首部长度
占4位，以4个字节为单位，该字段大小最大为15，因此，IP头部最大为60个字节
3. 服务类型(TOS)
占8位，包含3位的优先权(现已忽略)，4位的服务类型和1位的保留位。
服务类型字段用于指示数据包的服务质量和路由策略，不同的服务类型对应着不同的路由策略。例如最小延迟、最大吞吐量、最高可靠性、最小费用等。
4. 总长度
占16位，以字节为单位，IP数据包最大为65535字节。
5. 标识
占16位，用来标识一个IP包，每发送一个此值增加1
6. 标志与片偏移
占3位，其中一位不使用，第二位DF(Don't Fragment)若该值为1，表示不支持分片，若传输数据报大于MTU，那么直接丢弃，并发送一个ICMP差错报文。第三位MF(mnore Fragment)若该值为1，表示后续有分片，最后一个分片为0.
IP数据包分片之后，每个分组都有自己的头部，但是片偏移值不同，可以根据片偏移值来重组头部。
7. TTL(Time to live)
最多能够经过的路由器数量，每经过一个路由器，该值减一，为0时，丢弃该数据报，并发送一个ICMP错误信息给源主机。TTL可以避免数据包在路由器之间不停循环。

8. 协议类型
表示IP层上承载的是哪个高级协议，方面目的主机在解封的过程中更具协议类型，做不同的处理，类似于链路层的协议类型起到的作用，这里的协议类型包含TCP, UDP, IGMP, ICMP.
9. 头部校验和
保持头部数据的完整性，但校验不包括数据部分，主要有两个原因，一是将所有数据封装在IP数据包中的高层协议均含有覆盖整个数据的校验和，因而没有必要重复校验；二是每经过一个路由器，IP数据包的头部会发生变化，而数据部分不变。
IP数据包的头部可能有以下变化：变动目标IP地址，TTL字段、校验和、标志位（是否需要分片)

10. 源IP地址
发送数据的主机IP地址
11. 目的IP地址
接受数据的主机IP地址
12. 选项与填充
包括路径记录和时间戳等
路径记录：记录所经历路由器的IP地址
时间戳：记录所经历路由器的IP地址和时间
13. 网际校验和
占16位，两个字节.
 将所有的IP头部数据分为许多个16个字节，如IP头部如果有60个字节，那么就划分为4个16个字节，然后将这4个16个字节相加，若有溢出，将溢出位加到最后，得到的结果取反码，然后将结果放在网际校验和字段中，网际校验和刚好占据16位。

在接收端，同样将所有的IP头部数据分为许多个16个字节，取反码相加后，观察其结果是否等于0xffff, 若等于，证明IP头部数据在传输过程中大概率没有差错。


### 路由
可以通过route -n 查询本机当前的路由表
如果目的主机和当前主机同处在一个子网中，那么就可以直接将数据传递给目的主机。
如果不处于同一个子网中，那么就查找路由表，如果路由表中有相应的目的主机的IP地址，就根据路由表的信息跳转到下一个路由器。如果路由表中没有目的主机IP地址，就发送给默认网关


## 传输层
### TCP特点
无边界：无边界意味着传递同一批数据，传送端和接收端可以采用任意次数用来传送和接受数据。传递基于segment, 即字节流，意味着可能会出现数据边界问题。

面向连接：传递数据，首先要建立端与端之间的连接。
可靠传输：重传机制，网际校验和, 序列（保证序列不会重复和失序）
缓冲传输：TCP可能并不会立即传输segment, 而是放在缓冲区，等待一个合适的时机进行传送。
全双工： 发送时也可以接受数据。
流量控制：通过窗口机制来得到。

### TCP报文格式
分析TCP头部，就是分析TCP报文格式 
共16+16+32+32+4+6+16+16+16+32 = 5\*32=160bit = 10bytes;
1. 源端口号和目的端口号
均为16位, 加上IP头部的两个IP地址唯一确定一个TCP连接
2. 序列号
32位, 表示这个报文段中第一个数据字节序号
3. 确认号
32位, 仅当ACK标志位为1时有效，表示期望收到的下一个数据字节的序号
4. 头部长度
4位，单位位4个字节，头部长度最大为60个字节
5. 保留位
6位，全部为0
7. 标志位
共6位，
7.1 URG： 表示紧急指针有效
7.2 ACK： 表示确认信号有效
7.3 PSH:  表示接收方应尽快将这个报文段交给应用层
7.4 RST： 连接重置
7.5 SYN:  同步序号用来发起一个连接
7.6 FIN： 表示将要终止一个连接
8. 窗口大小
共16位, 通过窗口大小来达到流量控制
9. TCP校验和
共16位, 对TCP头和数据进行校验。
10. 紧急指针
共16位, 是一个正的偏移量，当URG标志位为1时，与序号字段中的值相加表示紧急数据最后一个字节的序号。TCP的紧急方式是发送端向另一端发送紧急数据的一种方式。紧急形式发送的数据通常也称为带外数据。
11. 选项
32位, 最常见的可选字段是最长报文大小(Maximum Segment Size)，每个连接方都会在通信的第一个报文段指明这个选项，指明本端能够接受的最大长度的报文段。该选项如果不设置，默认536(MTU通常为576，536+TCP头部长度(20)+IP头部长度20=576). 考虑到我们尽量要尽量避免在IP层分片。

### 三次握手与五次挥手
三次握手与五次挥手之所以要在传输层进行分析，是因为，不同的传输形式TCP，UDP握手与挥手的差距很大，UDP中不存在连接，因而UDP头部也不存在ACK,SYN, FIN等标志位

三次握手的过程如下：
1. 主机A向主机B发送了一个SYN的同步序号，序列号为a,渴望发起连接。
2. 主机B接收到该连接请求后，向A发起了一SYN号为b的同步序号和一个确认号为a+1的报文，确认号为a+1表示收到了序列号为a的同步序号，收到的下一个序号为a+1。
3. 主机A接收到主机B发送的数据报文时, 发送一个确认号为b+1的TCP报文，表示此时已收到了主机B发送的序列号为b的同步序号。此时双全工连接已经建立。

考虑一个问题，如果主机B没有收到主机A发送的确认号为b+1的报文，此时会发生什么？

四次挥手的过程如下：
1. 若客户端A主动关闭连接，那么在关闭连接之前，客户端收到了来自服务器的确认报文，假设该ACK号为x, 表示期望收到的下一个tcp报文的序列号为x
2. 客户端A主动关闭连接，这时客户端A发送一个FIN号为x, ACK号为y(这时的y可以自定义，但如果是服务器端主动关闭连接，那么y应该是客户端发送的最后一个TCP报文的序号)的TCP报文.此时断开了从客户端到服务器端的连接.
3. 服务器端B read函数返回0，阻塞中断，此时向客户端A发送一个ACK为y+1的报文，表示收到了FIN号为y的请求断开连接的报文。
4. 服务器端调用close函数，请求断开连接套接字，发送一个FIN为y(2中ACK号为y), ACK号为x+1的报文，请求断开连接
5. 客户端接收到断开连接请求后，发送ACK号为y+1的确认报文.

3和4之间有一个时间间隔，愿意是TCP报文是在内核中收到的，收到断开连接的请求后，可以直接发送确认报文到客户端。而返回应用层执行close等程序。这二者之间有一个时间差。这也就意味着即使read不返回0，此时服务器端也处于close\_wait状态。


### TCP如何保证可靠性
TCP的不可靠性体现在：差错、失序、丢包、重复
差错：维护一个端到端的检验和
失序：TCP头部有一个序列号
重复: TCP头部有一个序列号
丢包：超时重传机制

检验和：
若接收端发现检验和出现差错，将丢弃收到的报文，不发送确认报文，等待发送端超时重传。
失序和重复：
失序会根据序列号重新排序，而重复会丢弃报文，等待重新发送。
超时重传机制：
当TCP发送一个报文段时，维护一个定时器，若在规定时间之内没有收到确认报文，将重传报文段。


### 滑动窗口机制
TCP层设有缓存机制，TCP并不会立即发送segment, 而是将报文段发在缓冲区中，等待一个时机一起发送。
滑动窗口机制是为了流量控制，尽量避免网络的阻塞，对于发送端维护了一个发送窗口，对于接收端维护了一个接受窗口。
滑动窗口与缓冲区有关，滑动窗口大小小于缓冲区大小.
对于发送窗口而言，发送窗口将将其分成了四个组成部分, 已发送且已确认的部分，已发送但未确认的部分，允许发送但尚未发送和不允许发送的部分。发送窗口的大小等于中间二者之和。已发送未确认的部分经过确定之后，窗口右移，不允许发送的部分有部分报文段可以允许发送。
对于接受窗口而言，缓冲区可以分为四个部分, 已发送确认的部分、未按序收到的部分、允许接受的部分和不允许接受的部分。未按序收到的部分收齐后，接受窗口右移。

发送端发送的TCP报文段的个数不能超过接受端接受的窗口允许接受的个数。若超过，则会导致数据的丢失。但在发送时不知到接收窗口的大小.
在连接建立的时候，双方都会通告自身连接窗口的大小，因而双方都知道对端滑动窗口的大小。
问题： 传输的时候是通告滑动窗口的大小还是允许接受的大小。

#### 滑动窗口大小的选择
滑动窗口不能太小，也不能太大
如果TCP报文段生成的数量大于窗口容量，应用层会被阻塞，直至滑动窗口腾出多余空间。因此，如果滑动窗口太小，那么发送速度变慢，导致接受速度变慢。
窗口太大，考虑到路由器本身也存在一个缓冲队列，一次性传输报文段过大，超过了路由器的缓冲区载，同样会导致丢包，影响传输效率。
另外，发送窗口要和接受窗口大小相匹配
若发送窗口很大，而接受窗口较小，那么发送的TCP报文段会被接受端丢弃，导致重传，影响通信效率。

选取滑动窗口大小的方法
在建立连接过程中，发送端获取了接收端的接受窗口的大小，我们称为通告接受窗口(rwnd)。另外，考虑到路由器也具有缓冲区，因此，我们将现有网络所能承受的能力成为拥塞窗口(cwnd)，发送端采用的发送窗口的大小应等于二者的最小值。

考虑到网络所能承受能力是一个动态过程，因此，拥塞窗口的大小不断变化。那么如何确定拥塞窗口的大小呢？

TCP采用了两个阶段来确定拥塞窗口的大小, 逐渐地适应网路的环境：
1. 慢启动阶段
cwnd从1开始按指数增长直到ssthresh(慢启动阈值，一般是65535）
2. 拥塞避免阶段
cwnd开始按照线性增长，直到拥塞，将cwnd=1, ssthresh减半。

是一个自适应的过程，根据当前的网络状况，不断调整最适大小，若能收到ACK，那么增大cwnd, 否则减少。
