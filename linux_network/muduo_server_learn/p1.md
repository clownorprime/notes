## 服务器设计目标
高性能：及时快速的做出响应，要求编写的服务器能够最大程度上发挥机器的性能，使得机器在满负荷的情况下能够处理尽可能多的并发请求
高可用(HA): 7x24小时不间断工作, 出现故障，也可以自动转移到备用机，让备用机工作起来,不需要人工干预, failover.
伸缩性: 服务器具有良好的框架，分层设计，业务分离，并能进行灵活的部署。要求进程间通信不能采用本地通信机制，如共享内存，而应该采用跨机器的TCP通信等机制。

##典型的服务器结构
包括大量的客户请求，应用服务器和数据服务器。
应用服务器要能处理大量的客户端和网络I/O, 这里客户端应该使用epoll来进行编程.
应用服务器为了充分发挥机器的性能，也应该采用高性能编程技术.
###数据库瓶颈处理方法
数据库往往是瓶颈所在。主要有两种瓶颈：
1. 超过数据库连接数
数据库最大并发连接限制数为10个，应用服务器这边有1000个并发请求，将会有990个请求失败。
这里可以考虑在应用服务器和数据库之间增加一个中间层DAL(database access layer数据访问层), 是一个队列，服务器的设计具有伸缩性,那么DAL即可以跟APP部署在一起，也可以单独部署, 在单独部署情况下，应采用TCP进行通信. DAL是一个队列，里面对所有的并发请求进行排序，甚至也可以做一个连接池(DAL与数据库连接时，可以从数据库中申请一些连接，放在DAL的连接池中，下一次并发请求时就不需要创建与数据库的连接，直接从连接池中取出一个连接进行处理，从而提高访问速 DAL是一个队列，里面对所有的并发请求进行排序，甚至也可以做一个连接池(DAL与数据库连接时，可以从数据库中申请一些连接，放在DAL的连接池中，下一次并发请求时就不需要创建与数据库的连接，直接从连接池中取出一个连接进行处理, 这种情况下由于不需要重新创建与数据库的连接，只需要从连接池中取出一个已创建的连接进行处理，因此其效率更高。

2. 超出时限
数据库并发连接为10个，数据库1秒内最多能处理1000个请求，应用服务器这里有10000个并发请求，会出现0-10秒的等待, 如果系统规定的响应的最大时间为5秒，那么这里只能处理5000个请求，其余的5000个请求会出现超时，这里数据库的并发能力为5000.
###如何降低数据库的压力
#### 业务逻辑分离
1. 尽可能将主要业务逻辑放在应用服务器中，而数据库中仅仅进行辅助业务处理，在数据库层面处理逻辑或占用资源的能力不如在应用服务器，因为应用服务器进行计算与操作系统直接联系。#这里没看懂
#### 使用缓存
2. 缓存
缓存一部分数据，从而减少对数据库的访问。应用服务器提交请求时，直接从缓存中提取数据，从而降低对数据库的压力。

cache同步有三种方式：
1. cache aside: 同时更新缓存和数据库
2. read/write through: 先更新缓存，缓存负责同步更新数据库
3. write behind cache: 先更新缓存，缓存定时更新到数据库
其中2还有一种情况，缓存中没有找到要update的block，这时需要先更新数据库，然后由数据库同步更新到cache.
相对来说，1效率太差，3实时性较差，2效率和实时性更好，但实现较为麻烦。

cache可以用开源的软件来实现，并且由于cache对于数据的一致性要求不高，可以考虑nosql.关系型数据库一般存放一致性要求较高的数据，nosql可以存储一致性要求不高的数据，因此可以将nosql作为缓存来使用。比如说redis, memcached都可以作为分布式的缓存。

cache可以和app部署在同一台机器上，也可以部署在不同的机器上
前一种情况下，cache是局部机器的缓存，而不是全局的缓存
cache如果是部署在独立的机器上，并且采用分布式机制，那么这种情况下，cache对所有的app都是全局可见的.

#### 数据库读写分离
上诉是一些解决数据库瓶颈的解决方法，但是当大量的并发请求出现时，数据库仍然可能会出现瓶颈，需要进一步优化，这里可以使用数据库读写分离。

对于大部分数据库，读操作大于写操作，这时可以对数据库进行负载均衡，可以采用replication机制。即主从机制，数据库分为一个master数据库和多个slave数据库，master负责写操作，而slave负责读操作。这时DAL(数据访问层）更加复杂，对于写操作应该访问master库，而master库一旦更新，那么应该同步到slave库，从而保证读到正确的数据。

### 应用服务器性能瓶颈
#### 增加服务器数目和进行业务分割
应用服务器这边压力过大，可以增加应用服务器，应用服务器可以处理多种应用，我们可以将业务进行分割，server1只处理业务1，server2只处理业务2，etc.

#### 负载均衡
我们再新增加一个中间层，在客户端请求和应用服务器之间增加一个任务服务器。将任务服务器进行负载均衡。主要有两种方法：
1. 应用服务器被动接受任务
任务服务器可以监控应用服务器的负载，CPU高、IO高、并发高、内存换页高, 查询到这些信息后，选择负载最小的应用服务器分配任务。
2. 应用服务器主动接受任务
应用服务器主动到任务服务器接收任务进行处理。
该任务服务器也被称为反向代理服务器，和正向代理服务器的区别在于：正向代理是为用户服务的，而负向代理是为应用服务器服务的。

数据库

服务器性能四大杀手
数据拷贝：减少对内存的拷贝，通过使用缓存来进行解决。是服务器内部的缓存，而不是分布式的缓存，比如从内核到应用层有一部分缓存.
环境切换：应理性创建线程。该不该用多线程，单核服务器（采用状态机编程，效率最佳).比如大量的任务，提交到服务器，若采用多线程编程，会增加线程切换开销。这时可以使用状态机编程。即一个任务处理一段时间，处于某种状态，保存该状态，切换到另外一个任务，最终有序的把任务都处理完。也就是进程切换。服务器是多核的，多线程能充分发挥多核服务器的性能，但也要尽量避免线程开销。
内存分配：增加内存池，减少像操作系统动态申请内存。内存池还可以避免内存碎片化，增加内存的使用效率.
锁竞争： 应使用逻辑避免锁的竞争， 将数据库分库在一定程度上可以避免锁竞争。
